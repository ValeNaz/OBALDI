generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  MEMBER
  SELLER
  ADMIN
}

enum MembershipPlanCode {
  ACCESSO
  TUTELA
}

enum PointsPolicyType {
  NONE
  FIXED_PER_RENEWAL
  CONVERT_FEE_TO_POINTS
}

enum MembershipStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum Provider {
  STRIPE
  PAYPAL
}

enum CheckoutSessionKind {
  MEMBERSHIP
}

enum CheckoutSessionStatus {
  CREATED
  APPROVED
  PAID
  FAILED
  EXPIRED
}

enum PointsLedgerReason {
  RENEWAL
  SPEND
  ADJUSTMENT
  REFUND
}

enum PointsLedgerRefType {
  MEMBERSHIP
  ORDER
  ADMIN
}

enum ProductStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum ProductMediaType {
  IMAGE
  VIDEO
}

enum ProductCategory {
  ELECTRONICS
  HOME
  FASHION
  BEAUTY
  SPORTS
  OTHER
}

enum ChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  CREATED
  PAID
  CANCELED
  REFUNDED
}

enum OrderPaidWith {
  MONEY
  POINTS
  MIXED
}

enum ContentPostType {
  NEWS
}

enum ContentPostStatus {
  DRAFT
  PUBLISHED
}

enum PurchaseAssistStatus {
  OPEN
  IN_REVIEW
  DONE
}

enum ShipmentStatus {
  PENDING
  LABEL_CREATED
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum InventoryReason {
  ORDER
  RESTOCK
  ADJUSTMENT
  RETURN
  CANCEL
}

model User {
  id              String    @id @default(uuid()) @db.Uuid
  email           String    @unique
  emailVerifiedAt DateTime? @db.Timestamptz(6)
  passwordHash    String?
  role            UserRole
  firstName       String?
  lastName        String?
  phone           String?
  bio             String?
  avatarUrl       String?
  isDisabled      Boolean   @default(false)
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(6)

  sessions               Session[]
  membership             Membership?
  pointsLedger           PointsLedger[]
  products               Product[]
  productChangeRequests  ProductChangeRequest[]
  orders                 Order[]
  purchaseAssistRequests PurchaseAssistRequest[]
  auditLogs              AuditLog[]              @relation("AuditLogActor")
  passwordResetTokens    PasswordResetToken[]
  notifications          Notification[]
  settings               UserSettings?
  addresses              Address[]
  reviews                Review[]
  wishlistItems          WishlistItem[]
  conversations          ConversationParticipant[]
  messages               Message[]

  @@map("users")
}

model Session {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String   @unique
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String   @unique
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
  @@map("password_reset_tokens")
}

model MembershipPlan {
  id                   String             @id @default(uuid()) @db.Uuid
  code                 MembershipPlanCode @unique
  priceCents           Int
  currency             String             @default("EUR")
  periodDays           Int                @default(28)
  pointsPolicyType     PointsPolicyType
  pointsFixedAmount    Int?
  pointsConversionRate Decimal?           @db.Decimal(10, 4)
  isActive             Boolean            @default(true)

  memberships      Membership[]
  checkoutSessions CheckoutSession[]

  @@map("membership_plans")
}

model Membership {
  id                 String           @id @default(uuid()) @db.Uuid
  userId             String           @unique @db.Uuid
  planId             String           @db.Uuid
  status             MembershipStatus
  currentPeriodStart DateTime         @db.Timestamptz(6)
  currentPeriodEnd   DateTime         @db.Timestamptz(6)
  autoRenew          Boolean          @default(true)
  provider           Provider
  providerSubId      String           @unique
  createdAt          DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime         @updatedAt @db.Timestamptz(6)

  user User           @relation(fields: [userId], references: [id])
  plan MembershipPlan @relation(fields: [planId], references: [id])

  @@index([status])
  @@index([currentPeriodEnd])
  @@map("memberships")
}

model CheckoutSession {
  id                String                @id @default(uuid()) @db.Uuid
  kind              CheckoutSessionKind
  planId            String                @db.Uuid
  email             String
  provider          Provider
  providerSessionId String                @unique
  status            CheckoutSessionStatus
  expiresAt         DateTime              @db.Timestamptz(6)
  createdAt         DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime              @updatedAt @db.Timestamptz(6)

  plan MembershipPlan @relation(fields: [planId], references: [id])

  @@index([email])
  @@index([status])
  @@index([expiresAt])
  @@map("checkout_sessions")
}

model PointsLedger {
  id        String              @id @default(uuid()) @db.Uuid
  userId    String              @db.Uuid
  delta     Int
  reason    PointsLedgerReason
  refType   PointsLedgerRefType
  refId     String
  createdAt DateTime            @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@map("points_ledger")
}

model Product {
  id             String          @id @default(uuid()) @db.Uuid
  sellerId       String          @db.Uuid
  title          String
  description    String
  specsJson      Json            @db.JsonB
  priceCents     Int
  currency       String          @default("EUR")
  status         ProductStatus
  isOutOfStock   Boolean         @default(false)
  premiumOnly    Boolean         @default(false)
  pointsEligible Boolean         @default(false)
  pointsPrice    Int?
  category       ProductCategory @default(OTHER)
  isFeatured     Boolean         @default(false)
  isHero         Boolean         @default(false)
  isPromo        Boolean         @default(false)
  isSplit        Boolean         @default(false)
  isCarousel     Boolean         @default(false)
  isCollection   Boolean         @default(false)
  adminTag       String?
  // Enhanced fields
  slug           String?         @unique
  brand          String?
  weight         Int? // in grams
  dimensionsJson Json?           @db.JsonB // { width, height, depth, unit }
  seoTitle       String?
  seoDescription String?

  // Inventory tracking
  stockQty       Int      @default(0)
  lowStockAlert  Int      @default(5)
  trackInventory Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)

  seller             User                   @relation(fields: [sellerId], references: [id])
  media              ProductMedia[]
  options            ProductOption[]
  variants           ProductVariant[]
  changeRequests     ProductChangeRequest[]
  orderItems         OrderItem[]
  inventoryMovements InventoryMovement[]
  reviews            Review[]
  wishlistItems      WishlistItem[]

  @@index([status])
  @@index([sellerId])
  @@index([title])
  @@index([slug])
  @@map("products")
}

model ProductOption {
  id        String   @id @default(uuid()) @db.Uuid
  productId String   @db.Uuid
  name      String // e.g. "Color", "Size"
  values    String[] @db.Text // e.g. ["Red", "Blue"] or ["S", "M", "L"]
  position  Int      @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_options")
}

model ProductVariant {
  id                  String  @id @default(uuid()) @db.Uuid
  productId           String  @db.Uuid
  title               String // e.g. "Red / S"
  sku                 String? @unique
  priceCents          Int? // Override product price if set
  compareAtPriceCents Int? // Original price (strikethrough)
  stockQty            Int     @default(0)
  attributesJson      Json    @db.JsonB // { "Color": "Red", "Size": "S" }
  mediaIndex          Int? // Index of the image in product.media to show

  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems         OrderItem[]
  inventoryMovements InventoryMovement[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@index([productId])
  @@map("product_variants")
}

model ProductMedia {
  id          String           @id @default(uuid()) @db.Uuid
  productId   String           @db.Uuid
  type        ProductMediaType
  url         String
  storagePath String?
  sortOrder   Int
  createdAt   DateTime         @default(now()) @db.Timestamptz(6)

  product Product @relation(fields: [productId], references: [id])

  @@index([productId, sortOrder])
  @@map("product_media")
}

model ProductChangeRequest {
  id               String              @id @default(uuid()) @db.Uuid
  productId        String              @db.Uuid
  sellerId         String              @db.Uuid
  proposedDataJson Json                @db.JsonB
  status           ChangeRequestStatus
  adminNote        String?
  createdAt        DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime            @updatedAt @db.Timestamptz(6)

  product Product @relation(fields: [productId], references: [id])
  seller  User    @relation(fields: [sellerId], references: [id])

  @@index([productId, status])
  @@map("product_change_requests")
}

model Order {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @db.Uuid
  status            OrderStatus
  totalCents        Int
  currency          String        @default("EUR")
  paidWith          OrderPaidWith
  pointsSpent       Int           @default(0)
  shippingIncluded  Boolean       @default(true)
  provider          Provider
  providerPaymentId String?
  // Shipping address
  shippingAddressId String?       @db.Uuid
  // Coupon/discount
  couponId          String?       @db.Uuid
  discountCents     Int           @default(0)
  createdAt         DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime      @updatedAt @db.Timestamptz(6)

  user            User        @relation(fields: [userId], references: [id])
  items           OrderItem[]
  shippingAddress Address?    @relation(fields: [shippingAddressId], references: [id])
  coupon          Coupon?     @relation(fields: [couponId], references: [id])
  shipment        Shipment?
  reviews         Review[]

  @@index([userId, createdAt])
  @@map("orders")
}

model OrderItem {
  id             String  @id @default(uuid()) @db.Uuid
  orderId        String  @db.Uuid
  productId      String  @db.Uuid
  variantId      String? @db.Uuid
  qty            Int
  unitPriceCents Int
  unitPoints     Int?

  order   Order           @relation(fields: [orderId], references: [id])
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model ContentPost {
  id          String            @id @default(uuid()) @db.Uuid
  type        ContentPostType
  title       String
  slug        String            @unique
  excerpt     String?
  body        String
  tags        String[]          @db.Text
  status      ContentPostStatus
  publishedAt DateTime?         @db.Timestamptz(6)
  createdAt   DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime          @updatedAt @db.Timestamptz(6)

  @@index([status, publishedAt])
  @@map("content_posts")
}

model PurchaseAssistRequest {
  id         String               @id @default(uuid()) @db.Uuid
  userId     String               @db.Uuid
  urlToCheck String
  notes      String?
  status     PurchaseAssistStatus
  outcome    String?
  createdAt  DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime             @updatedAt @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@map("purchase_assist_requests")
}

model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  actorUserId  String?  @db.Uuid
  action       String
  entity       String
  entityId     String?  @db.Uuid
  metadataJson Json     @db.JsonB
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  actorUser User? @relation("AuditLogActor", fields: [actorUserId], references: [id])

  @@index([createdAt])
  @@index([actorUserId])
  @@index([entity, entityId])
  @@map("audit_logs")
}

model WebhookEvent {
  id          String    @id @default(uuid()) @db.Uuid
  provider    Provider
  eventId     String    @unique
  type        String
  payload     Json      @db.JsonB
  processedAt DateTime? @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)

  @@map("webhook_events")
}

enum NotificationType {
  ORDER_CREATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  PRODUCT_APPROVED
  PRODUCT_REJECTED
  POINTS_EARNED
  MEMBERSHIP_RENEWED
  SYSTEM
  NEW_MESSAGE
}

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @db.Uuid
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model UserSettings {
  id               String  @id @default(uuid()) @db.Uuid
  userId           String  @unique @db.Uuid
  notifyOrders     Boolean @default(true)
  notifyPromotions Boolean @default(true)
  notifyNewsletter Boolean @default(false)
  darkMode         Boolean @default(false)
  language         String  @default("it")

  user User @relation(fields: [userId], references: [id])

  @@map("user_settings")
}

model ProductView {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @db.Uuid
  productId String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([userId, createdAt])
  @@index([productId])
  @@map("product_views")
}

// ========================================
// NEW MODELS - Backend Improvements
// ========================================

model Address {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  label      String?
  fullName   String
  line1      String
  line2      String?
  city       String
  province   String
  postalCode String
  country    String   @default("IT")
  phone      String?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  user   User    @relation(fields: [userId], references: [id])
  orders Order[]

  @@index([userId])
  @@map("addresses")
}

model Shipment {
  id           String         @id @default(uuid()) @db.Uuid
  orderId      String         @unique @db.Uuid
  carrier      String?
  trackingCode String?
  trackingUrl  String?
  status       ShipmentStatus @default(PENDING)
  estimatedAt  DateTime?      @db.Timestamptz(6)
  shippedAt    DateTime?      @db.Timestamptz(6)
  deliveredAt  DateTime?      @db.Timestamptz(6)
  createdAt    DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime       @updatedAt @db.Timestamptz(6)

  order Order @relation(fields: [orderId], references: [id])

  @@map("shipments")
}

model Review {
  id         String   @id @default(uuid()) @db.Uuid
  productId  String   @db.Uuid
  userId     String   @db.Uuid
  orderId    String   @db.Uuid
  rating     Int // 1-5
  title      String?
  body       String?
  isVerified Boolean  @default(true)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@unique([userId, productId])
  @@index([productId, createdAt])
  @@map("reviews")
}

model WishlistItem {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  productId String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
  @@index([userId])
  @@map("wishlist_items")
}

model Coupon {
  id               String     @id @default(uuid()) @db.Uuid
  code             String     @unique
  type             CouponType
  value            Int // cents for FIXED_AMOUNT, percentage*100 for PERCENTAGE
  minOrderCents    Int?
  maxDiscountCents Int?
  maxUses          Int?
  usedCount        Int        @default(0)
  validFrom        DateTime?  @db.Timestamptz(6)
  validUntil       DateTime?  @db.Timestamptz(6)
  isActive         Boolean    @default(true)
  createdAt        DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime   @updatedAt @db.Timestamptz(6)

  usages CouponUsage[]
  orders Order[]

  @@map("coupons")
}

model CouponUsage {
  id        String   @id @default(uuid()) @db.Uuid
  couponId  String   @db.Uuid
  orderId   String   @db.Uuid
  userId    String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  coupon Coupon @relation(fields: [couponId], references: [id])

  @@unique([couponId, orderId])
  @@index([userId])
  @@map("coupon_usages")
}

model InventoryMovement {
  id        String          @id @default(uuid()) @db.Uuid
  productId String          @db.Uuid
  variantId String?         @db.Uuid
  delta     Int // positive = restock, negative = sold/adjustment
  reason    InventoryReason
  orderId   String?         @db.Uuid
  note      String?
  createdAt DateTime        @default(now()) @db.Timestamptz(6)

  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([productId, createdAt])
  @@index([variantId])
  @@map("inventory_movements")
}

// ========================================
// MESSAGING SYSTEM
// ========================================

enum ConversationType {
  SUPPORT
  VENDOR_REPORT
}

enum ConversationStatus {
  OPEN
  CLOSED
  ARCHIVED
}

model Conversation {
  id            String             @id @default(uuid()) @db.Uuid
  type          ConversationType   @default(SUPPORT)
  status        ConversationStatus @default(OPEN)
  title         String?
  metadataJson  Json?              @db.JsonB
  lastMessageAt DateTime           @default(now()) @db.Timestamptz(6)
  createdAt     DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime           @updatedAt @db.Timestamptz(6)

  participants  ConversationParticipant[]
  messages      Message[]

  @@index([lastMessageAt])
  @@map("conversations")
}

model ConversationParticipant {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @db.Uuid
  userId         String   @db.Uuid
  lastReadAt     DateTime @default(now()) @db.Timestamptz(6)
  joinedAt       DateTime @default(now()) @db.Timestamptz(6)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @db.Uuid
  senderId       String   @db.Uuid
  body           String
  metadataJson   Json?    @db.JsonB
  attachmentUrl  String?
  isSystem       Boolean  @default(false)
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}
